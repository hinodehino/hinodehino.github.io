<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>TPS test</title><link rel="stylesheet" type="text/css" href="fontstyles.css">
	<link rel="stylesheet" type="text/css" href="metris.css">
	<link rel="shortcut icon" href="favicon.png" type="image/png">
    <style type="text/css">
		html{
    		overflow: hidden;
    	}
    	body{
			width: 100vw;
			height: 100vh;
			margin: 0;
			padding: 0;
			font-family: 'TT Commons';
			color: #222;
		}
		.dark{
			background: #1a1b1c;
			color: white;
		}
		#content{
			font-size: 36px;
			font-weight: 500;
			width: 100%;
			height: 100%;
			display: flex;
			justify-content: center;
			align-items: center;
			flex-direction: column;
		}
		#stats{
			transition: opacity .25s ease;
		}
		#sub-metric{
			font-size: 18px;
			text-align: center;
		}
		.wide-btn{
			width: 100px;
			height: 25px;
		}
		#binds{
			margin-top: 10px;
			width: 110px;
			display: flex;
		}
		#binds div{
			width: 50%;
			height: 50px;
		}
		#top-menu{
			position: absolute;
			padding: 15px;
			display: flex;
			align-items: center;
		}
		#credit{
			text-decoration: none;
			color: #0d7eff;
			margin-left: 20px;
			font-weight: 500;
		}
		#theme-change{
			user-select: none;
			cursor: pointer;
			transition: all .2s ease;
		}
		#theme-change:active{
			transform: scale(0.8);
		}
		#theme-icon{
			width: 30px;
		}
		.inverse{
			filter: invert(100%);
		}
		@keyframes{
			from{opacity: 0};
		}
	</style>
</head>
<body>
	<div id="top-menu">
		<div id="theme-change" onclick="theme(this)">
			<img id="theme-icon" src="https://img.icons8.com/material-rounded/100/000000/sun.png"/>
		</div>
		<a target="_blank" href="https://vk.com/metriss" id="credit">@metriss</a>
	</div>
	<div id="content">
		<div id="stats">
			<div id="metric">0 taps</div>
			<div id="sub-metric">
				<div id="tps">0 tps</div>
				<div id="tpm">0 tpm</div>
				<div id="delay">0 ms</div>
			</div>
		</div>
		<div class="wide-btn btn btn-active btn-positive" id="control" onclick="track()" style="margin-top: 15px; margin-bottom: 5px">start</div>
		<div class="wide-btn btn btn-primary" id="drop-control" onclick="dropTracking()" style="margin-bottom: 5px">stop</div>
		<div class="wide-btn btn btn-active btn-negative" id="clear-control">clear</div>
		<div id="binds">
			<div id='1' class="btn btn-idle" style="margin-right: 10px;" onclick="rebind(1)">
				Z
			</div>
			<div id='2' class="btn btn-idle" onclick="rebind(2)">
				X
			</div>
		</div>
	</div>
</body>
<script type="text/javascript">
	var stats = document.getElementById("stats")
	var metric = document.getElementById("metric")
	var tpsmetric = document.getElementById("tps")
	var tpmmetric = document.getElementById("tpm")
	var delaymetric = document.getElementById("delay")
	var control = document.getElementById("control")
	var dropcontrol = document.getElementById("drop-control")
	var delay = 0;
	var delays = [];
	var taps = 0;
	var mode = 0;
	var num = 0;
	var countdown, finish;
	var btns = {
		1: document.getElementById('1'),
		2: document.getElementById('2')
	};
	var binds = {
		1: 'KeyZ',
		2: 'KeyX'
	};
	var darkMode = 0;

	var clear = function(){
		metric.innerText = '0 taps'
		tpsmetric.innerText = '0 tps'
		tpmmetric.innerText = '0 tpm'
		delaymetric.innerText = '0 ms'
	}
	document.getElementById("clear-control").addEventListener("click", function(){
		if (!mode){
			update()
			setTimeout(clear, 250)
		}
	})

	var update = function(){
		stats.style.opacity = '0'
		setTimeout(function(){
			stats.style.opacity = '1'
		}, 250)
	}

	var theme = function(e){
		if (!darkMode){
			document.body.classList.add('dark')
			e.classList.add('inverse')
			darkMode = 1
		} else {
			document.body.classList.remove('dark')
			e.classList.remove('inverse')
			darkMode = 0
		}
	}

	var change = function(e){
		binds[num] = e.code
		btns[num].classList.remove('btn-idle-act')
		if (e.key.length <= 3){
			btns[num].innerText = e.key.toUpperCase()
		} else{
			btns[num].innerText = e.key.substring(0, 3).toUpperCase()
		}
		document.removeEventListener('keydown', change)
		num = 0
	}

	var rebind = function(n){
		if (!mode){
			if (!num){
				btns[n].classList.add('btn-idle-act')
				num = n
				document.addEventListener('keydown', change)
			}
		}
	}

	var tap = function(e){
		if (e.code == binds[1]){
			taps += 1
			metric.innerText = taps + ' taps'
			btns[1].classList.add('btn-idle-act')
			diff = new Date().getTime() - delay
			delays.push(diff)
			delaymetric.innerText = diff + ' ms'
			delay = new Date().getTime()
		} else if (e.code == binds[2]){
			taps += 1
			metric.innerText = taps + ' taps'
			btns[2].classList.add('btn-idle-act')
			diff = new Date().getTime() - delay
			delays.push(diff)
			delaymetric.innerText = diff + ' ms'
			delay = new Date().getTime()
		}
	}

	var leave = function(e){
		if (e.code == binds[1]){
			btns[1].classList.remove('btn-idle-act')
		} else if (e.code == binds[2]){
			btns[2].classList.remove('btn-idle-act')
		}
	}

	var dropTracking = function(){
		if (mode){
			dropcontrol.classList.remove('btn-active')
			btns[1].style.transition = 'all .2s ease'
			btns[2].style.transition = 'all .2s ease'
			clearInterval(countdown)
			clearTimeout(finish)
			document.removeEventListener('keydown', tap)
			update()
			setTimeout(function(){
				tpsmetric.innerText = taps / 5 + ' tps'
				tpmmetric.innerText = taps / 5 * 60 + ' tpm'
				taps = 0
				control.classList.add('btn-active')
				control.innerText = 'start'
				if (delays.length){
					var sum = 0;
					for(var i = 0; i < delays.length; i++){
						sum += delays[i]
					}
					delaymetric.innerText = (sum / delays.length).toFixed(0) + ' ms'
				}
				mode = 0
			}, 250)
		}
	}

	var track = function(){
		if (!mode & !num){
			clear()
			mode = 1
			control.innerText = '5s'
			control.classList.remove('btn-active')
			dropcontrol.classList.add('btn-active')
			btns[1].style.transition = 'none'
			btns[2].style.transition = 'none'
			timeLeft = 4
			delay = new Date().getTime()
			countdown = setInterval(function(){
				control.innerText = timeLeft + 's'
				timeLeft -= 1
			}, 1000)
			document.addEventListener('keydown', tap)
			document.addEventListener('keyup', leave)
			finish = setTimeout(dropTracking, 5000)
		}
	}
</script>
</html>
